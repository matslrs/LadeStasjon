<!DOCTYPE html>
<html>
<head>
	<!-- <meta http-equiv="X-UA-Compatible" content="IE=Edge"> -->
	<!-- bower:css -->
	<link rel="stylesheet" href="bower_components/leaflet/dist/leaflet.css" />
	<link rel="stylesheet" href="bower_components/leaflet.markercluster/dist/MarkerCluster.css" />
	<link rel="stylesheet" href="bower_components/leaflet.markercluster/dist/MarkerCluster.Default.css" />
	<link rel="stylesheet" href="bower_components/Leaflet.awesome-markers/dist/leaflet.awesome-markers.css" />
	<link rel="stylesheet" href="bower_components/sidebar-v2/css/leaflet-sidebar.css" />
	<link rel="stylesheet" href="bower_components/leaflet-search/dist/leaflet-search.src.css" />
	<link rel="stylesheet" href="bower_components/components-font-awesome/css/font-awesome.css" />
	<!-- endbower -->
	
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<link rel="stylesheet" href="https://code.ionicframework.com/ionicons/1.5.2/css/ionicons.min.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" href="images/foundation-icons/foundation-icons.css" />
	<link rel="stylesheet" href="css/themeStyle.css" />
	<link rel="stylesheet" href="css/style.css" />


	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<meta charset="UTF-8"> 	
	<script>
			
		//-----------------------------
		//SETTINGS	
		//SELECT BASE START MAP!
		var startMap                 = "OpenStreetMap";	//check the function
		//Base layers
		var useOsmLayer              = true;
		var useKartverkGraatoneLayer = true;
		//Overlay layers
		var useStaticNobilLayer      = true;
		var useRealTimeNobilLayer    = true;
		//only norway
		var useOnlyNor               = false;
		//Marker Clustering
		var clusterRadius            = 80;	//lower number --> smaller but more cluster points
		//Get Lat/long on map click
		var latLongClick             = false;
		//fylkeGeojson
		var useFylkerDbQ = true;
		//NVE
		var useFloodData = true;
		var useLandslideData = true;
		//END SETTINGS
		//-----------------------------
		
		//-----------------------------
		//GLOBAL VARIABLES
		var activeSidebarStation  = "none";
		var mymap                 = {};	
		var layerControl          = {};	
		var parentCluster         = {};	
		var activeOverlays        = [];
		var overlayMaps           = [];
		var chargingStationsArray = {};
		var staticNobil           = {};
		var streamNobilAvailable  = {};
		var streamNobilOccupied   = {};
		var streamNobilUnknown    = {};
		var streamNobilError      = {};
		var fylkeQuery            = {};
		var flomDataQuery         = {};
		var skredDataQuery        = {};
		var sidebarLayers         = {};
		var sidebarInfo           = {};
		var preferredPanel        = [1,0,0];	//sets which panels to open by default in sidebar
		function templateFunction() {
		    // ...
		}
		//END GLOBAL VARIABLES
		//-----------------------------
	</script>	

</head>

<body>

	<div id="sidebarLayers" class="sidebar collapsed">
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#layersList" role="tab"><i class="fa fa-bars"></i></a></li>
            </ul>
        </div>

        <div class="sidebar-content">
            <div class="sidebar-pane" id="layersList">
                <h1 class="sidebar-header">
                    <div id="overSkrift"> Data lag</div>
                    <span class="sidebar-close"><i class="fa fa-times"></i></span>
                </h1>
                <div class="sidebar-body">
                <p id="layerContainer">

	                <div id="menu">
						<div class="panel list-group">
						<a href="#" class="list-group-item " data-toggle="collapse" data-target="#transport"><strong> Transport <span class="glyphicon glyphicon-road pull-right"></span></strong></a>
							<div id="transport" class="sublinks collapse">
							  	<ul class="list-group checked-list-box no-margins">
					                <a id="layerBomstasjon" class="list-group-item small "> Bomstasjoner <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
			                	</ul>
							</div>
						<a href="#" class="list-group-item " data-toggle="collapse" data-target="#chargingStation"><strong> Elbil Ladestasjoner <span class="glyphicon glyphicon-battery-charging pull-right"></span></strong></a>
							<div id="chargingStation" class="sublinks collapse">
							  	<ul class="list-group checked-list-box no-margins">
					                <a id="layerLadeAvailable" class="list-group-item small "> Ladestajoner Ledig<span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <a id="layerLadeOccupied" class="list-group-item small "> Ladestajoner i Bruk<span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <a id="layerLadeError" class="list-group-item small "> Ladestajoner Feil<span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <a id="layerLadeUnknown" class="list-group-item small "> Ladestajoner Ukjent<span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <a id="layerLadeStatisk" class="list-group-item small "> Ladestajoner Statisk <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
			                	</ul>
							</div>
						 <a href="#" class="list-group-item " data-toggle="collapse" data-target="#hobby"> <strong>Fritid <span class="glyphicon glyphicon-tree-conifer pull-right"></span></strong></a>
							 <div id="hobby" class="sublinks collapse">
								 <ul class="list-group checked-list-box no-margins">
					                <a id="playGround" class="list-group-item small "> Lekeplass <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <a id="swimmingArea" class="list-group-item small "> Badeplass <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <a id="outlookArea" class="list-group-item small "> Utsikts punkt <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
				                </ul>
							 </div>
						 <a href="#" class="list-group-item " data-toggle="collapse" data-target="#public"> <strong>Offentlig <span class="glyphicon glyphicon-building pull-right"></span></strong></a>
							 <div id="public" class="sublinks collapse">
							  	<ul class="list-group checked-list-box no-margins">
					                <a id="kindergartenStavanger" class="list-group-item small "> Barnehage Stavanger <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <!-- <a id="schoolStavanger" class="list-group-item small "> Grunnskole Stavanger <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a> -->
					                <a id="healthStationLayer" class="list-group-item small "> Helsestasjon Stavanger <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <a id="healthBuildingLayer" class="list-group-item small "> Helsebygg Stavanger <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <a id="cemeteryStavanger" class="list-group-item small "> Gravlunder Stavanger <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <a id="faithBuildingStavanger" class="list-group-item small "> Trosbygninger Stavanger <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a> 
					                <a id="enviornmentStationLayer" class="list-group-item small "> Miljøstasjon <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <a id="toiletLayer" class="list-group-item small "> Toalett <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <a id="kindergartenGjesdal" class="list-group-item small "> Barnehage Gjesdal <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <a id="schoolGjesdal" class="list-group-item small "> Grunnskole Gjesdal <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <a id="rentingSpaceGjesdal" class="list-group-item small "> Utleielokal Gjesdal <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
			                	</ul>
							 </div> 
						<!-- <a href="#" class="list-group-item " data-toggle="collapse" data-target="#weather"> <strong>Vær <span class="glyphicon glyphicon-cloud pull-right"></span></strong></a>
							 <div id="weather" class="sublinks collapse">
							  	<ul class="list-group checked-list-box no-margins">
					                <a id="wheaterForecast" class="list-group-item small "> Værmedlinger <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <a id="nveVarsel" class="list-group-item small "> Varsel områder <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
			                	</ul>
							 </div> -->
						<a href="#" class="list-group-item " data-toggle="collapse" data-target="#borders"> <strong>Grenser <span class="glyphicon halflings-record-empty pull-right"></span></strong></a>
							 <div id="borders" class="sublinks collapse">
							  	<ul class="list-group checked-list-box no-margins">
					                <a id="fylkeBorder" class="list-group-item small "> Fylkes grenser <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
					                <a id="grunnkretsBorder" class="list-group-item small "> Grunnkrets grenser <span class="state-icon glyphicon glyphicon-unchecked pull-right"></a>
			                	</ul>
							 </div>
						</div>
					</div>
				 
                </p>
                </div>
            </div>
        </div>
    </div>

    <div id="sidebarInfo" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#stationInfo" role="tab"><i class="fa fa-map-marker"></i></a></li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="stationInfo">
                <h1 class="sidebar-header">
                    <div id="stationName">Charging Station</div>
                    <span class="sidebar-close"><i class="fa fa-times"></i></span>
                </h1>
                <div class="sidebar-body">
                <p id="stationDetails">
                	Click on a charging station to get information about that station.
                </p>
                </div>
            </div>
        </div>
    </div>


	<div id="mapid" class="sidebar-map"></div>
	<div class="descriptionBox"></div>
	<script src="bower_components/jquery/dist/jquery.js"></script>

	<script>


	$( document ).ready(function() {

		var templateSidebarNameHtml = $("#tmpl-sidebar-name").html();
		templateSidebarName = doT.template(templateSidebarNameHtml);
		var templateSidebarInfoHtml = $("#tmpl-sidebar-info").html();
		templateSidebarInfo = doT.template(templateSidebarInfoHtml);

		var templateSidebarInfoHtmlTest = $("#tmpl-sidebar-test").html();
		templateSidebarHtmlTest = doT.template(templateSidebarInfoHtmlTest);


		//create if use
		//DB maplytic
		if(useFylkerDbQ){
			var fylkeQuery = L.geoJson();
		}
		//NVE Flom data:
		if(useFloodData){
			var flomDataQuery = L.geoJson(null, {
			    style: function (feature) {
			        return {color: feature.properties.color};
			    },
			    onEachFeature: function (feature, layer) {
			        layer.bindPopup("<strong>" + feature.properties.navn +  "</strong> <br>" + "Varsel: " + feature.properties.beskrivelse);
			    }
			});
			var sqlFlomKommuner = null;
			var flomKommuneInfo = [];
		}

		//NVE Skred data:
		if(useLandslideData){
			var skredDataQuery = L.geoJson(null, {
			    style: function (feature) {
			        return {color: feature.properties.color};
			    },
			    onEachFeature: function (feature, layer) {
			        layer.bindPopup("<strong>" + feature.properties.navn +  "</strong> <br>" + "Varsel: " + feature.properties.beskrivelse);
			    }
			});
			var sqlSkredKommuner = null;
			var skredKommuneInfo = [];
		}
		//parent marker cluster
		parentCluster = new L.MarkerClusterGroup({
			showCoverageOnHover: false,
			animateAddingMarkers: true,
			maxClusterRadius: clusterRadius
		});
		//a child marker cluster
		//streamNobil = L.featureGroup.subGroup(parentCluster);
		streamNobilAvailable = L.featureGroup.subGroup(parentCluster);
		streamNobilOccupied  = L.featureGroup.subGroup(parentCluster);
		staticNobil          = L.featureGroup.subGroup(parentCluster);
		streamNobilUnknown   = L.featureGroup.subGroup(parentCluster);
		streamNobilError     = L.featureGroup.subGroup(parentCluster);

		//Set up icons to be used
		setupIcons();

		//bounds of the map
		var southWest = L.latLng(48, -35),
	    northEast = L.latLng(75, 65),
	    bounds = L.latLngBounds(southWest, northEast);

		//Creates MAP
		mymap = L.map('mapid', { 
			center: [58.8534, 5.7317],
			maxBounds: bounds,
			minZoom: 4,
			maxZoom: 18,
			zoom: 8,
			zoomControl: false
		});


		L.control.zoom({
		     position:'topright'
		}).addTo(mymap);

		// mymap.addControl(new customControl());

		sidebarLayers = L.control.sidebar('sidebarLayers', {position: 'left'}).addTo(mymap);
		sidebarInfo = L.control.sidebar('sidebarInfo', {position: 'right'}).addTo(mymap);

		events(mymap);

		parentCluster.addTo(mymap);

		//sets up base map layers
		var baseMaps = setupBaseLayers(mymap);
		//sets up overlay layers
		var overlayMapsDummy = setupOverlayLayers(mymap);
		//overlayMaps = setupOverlayLayers(mymap);
		//var overlayMaps = [];
		//setupOverlayLayers(mymap);

		getStationsToBeUsed();

		//Layer control
		layerControl = L.control.layers(baseMaps, overlayMapsDummy).addTo(mymap);
		//var layerControl = L.control.layers(baseMaps, overlayMapsDummy).addTo(mymap);

		//Set initial base map here:
		baseMaps[startMap].addTo(mymap);
		// overlayMaps[" <i style='background-color:rgb(97,190,30)'></i>Available"].addTo(mymap);
		// overlayMaps[" <i style='background-color:rgb(240,131,0)'></i> Occupied"].addTo(mymap);
		// overlayMaps[" <i style='background-color:rgb(256,32,32)'></i> Error"].addTo(mymap);
		// overlayMaps[" <i style='background-color:rgb(69,69,69)'></i> Unknown"].addTo(mymap);

		//setupSearch(mymap);
		
		//find location and set view and zoom
		mymap.locate({
			setView: true,
			maxZoom: 16
		}); 	

		//ATTRIBUTIONS: 
   		mymap.attributionControl.addAttribution('<a href="http://info.nobil.no/">Nobil</a>');

		// var legend = L.control({position: 'bottomright'});
		// legend.onAdd = function (mymap) {
		//     var div = L.DomUtil.create('div', 'info legend');
	 //        div.innerHTML += '<i style="background-color:rgb(97,190,30)"></i> Kontakt(er) ledig <br>';
	 //        div.innerHTML += '<i style="background-color:rgb(240,131,0)"></i> Kontakt(er) opptatt <br>';
	 //        div.innerHTML += '<i style="background-color:rgb(30,144,255)"></i> Kontakt(er) statisk <br>';
	 //        div.innerHTML += '<i style="background-color:rgb(256,32,32)"></i> Kontakt(er) feil <br>';
	 //        div.innerHTML += '<i style="background-color:rgb(69,69,69)"></i> Kontakt(er) ukjent';
		//     return div;
		// };

		// legend.addTo(mymap);

		sidebarLayersListeners();


	});


	</script>

	<!-- bower:js -->
	<script src="bower_components/leaflet/dist/leaflet-src.js"></script>
	<script src="bower_components/dot/dot.min.js"></script>
	<script src="bower_components/jquery/dist/jquery.js"></script>
	<script src="bower_components/bootstrap-sass/assets/javascripts/bootstrap.js"></script>
	<script src="bower_components/leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>
	<script src="bower_components/Leaflet.awesome-markers/dist/leaflet.awesome-markers.js"></script>
	<script src="bower_components/sidebar-v2/js/leaflet-sidebar.js"></script>
	<script src="bower_components/leaflet-search/dist/leaflet-search.src.js"></script>
	<!-- endbower -->

	<script src="js/nobilUtils.js"></script>
	<script src="js/functions.js"></script>
	<script src="js/layers.js"></script>
	<script src="js/icons.js"></script>
	<script src="js/sidebarListeners.js"></script>
	<script src="js/leaflet.featuregroup.subgroup-src.js"></script>

	<script id="tmpl-sidebar-test" type="text/doT">
		<div id="sidebar" class="sidebar">
	        <div class="sidebar-content">
	            <div class="sidebar-pane" id="stationInfo">
	                <h1 class="sidebar-header">
	                    <div id="stationName">Charging Station</div>
	                    <span class="sidebar-close"><i class="fa fa-times"></i></span>
	                </h1>
	                <div class="sidebar-body">
	                <p id="stationDetails">
	                	Click on a charging station to get information about that station.
	                </p>
	                </div>
	            </div>
	        </div>
	    </div>
	</script>

	<script id="tmpl-sidebar-name" style="margin-bottom: 20px;" type="text/doT">
		Charging Station {{=it.uuid}}
	</script>

	<script id="tmpl-sidebar-info" type="text/doT">
		
		<div class="panel-group panel-group-sm">
		    <div class="panel panel-default panel-sm">
		      <div class="panel-heading panel-heading-sm">
		        <h5 class="panel-title">
		          <a data-toggle="collapse" href="#collapse1" onclick="updatePrefferedPanel(1)"><i class="material-icons">power</i> Connectors Info</a>
		        </h5>
		      </div>

				<div id="collapse1" class="panel-collapse 
				{{? it.preferredPanel[0] == 1}}
				collapse in
				{{??}}
				collapse
				{{?}}
				"> 
					<div class="panel-body">
						{{? it.isRealtime == 1}}
							<table class="table table-hover table-condensed">
								<tbody>
									<tr>
										<td>Kontakt Type</td><td>Kapasitet</td>
									</tr>
								{{~ it.connectors :value:index}}
								  	<tr>
									    <td>
									        {{? value.error == 1 }}
											<div class="led-box" data-toggle="tooltip" data-html="true" title=" {{=value.statusRead}} <br> <i>Last update: {{=new Date(value.timestamp)}} </i> ">
									     	 	<div class="led-red"></div>
										    </div>
											{{?? value.status == -1 }}
											<div class="led-box" data-toggle="tooltip" data-html="true" title=" {{=value.statusRead}} <br> <i>Last update: {{=new Date(value.timestamp)}} </i> ">
									     	 	<div class="led-grey"></div>
										    </div>
											{{?? value.status == 0 }}
											<div class="led-box" data-toggle="tooltip" data-html="true" title=" {{=value.statusRead}} <br> <i>Last update: {{=new Date(value.timestamp)}} </i> ">
									     	 	<div class="led-green"></div>
										    </div>
											{{?? value.status == 1 }}
											<div class="led-box" data-toggle="tooltip" data-html="true" title=" {{=value.statusRead}} <br> <i>Last update: {{=new Date(value.timestamp)}} </i> ">
									     	 	<div class="led-yellow"></div>
										    </div>
											{{?}}
										
											{{=value.connector}}
										</td>
										<td>
											{{=value.capacity}}
										</td>
									</tr>
								{{~}}				
								</tbody>
							</table>
						{{??}}
						<div class="alert alert-info alert-dismissible" role="alert" style="margin:0px;" >
						  <button type="button button-sm" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						  Stasjon gir ikke sanntids informasjon.
						</div>
						<table class="table table-hover table-condensed">
							<tbody>
								<tr>
									<td>Kontakt Type</td><td>Kapasitet</td>
								</tr>	
								{{~ it.connectors :value:index}}
							      <tr>
							        <td>{{=value.connector}}</td><td>{{=value.capacity}}</td>
							      </tr>
							    {{~}}					
							</tbody>
						</table>
						{{?}}
					</div>
				</div>
	    	</div>
		</div>

		<div class="panel-group panel-group-sm">
		    <div class="panel panel-default panel-sm">
		      <div class="panel-heading panel-heading-sm">
		        <h5 class="panel-title">
		          <a data-toggle="collapse" href="#collapse2" onclick="updatePrefferedPanel(2)"><i class="material-icons">ev_station</i>Charging Station Info</a>
		        </h5>
		      </div>
				<div id="collapse2" class="panel-collapse 
				{{? it.preferredPanel[1] == 2}}
				collapse in
				{{??}}
				collapse
				{{?}}
				"> 
					<div class="panel-body">
			
						<table class="table table-hover table-condensed">
							<tbody>
								<tr>
									<td>Antall Ladere</td><td>{{=it.connectors.length || ''}}</td>
								</tr>
								<tr>
									<td>Offentlig</td><td>{{=it.public || ''}}</td>
								</tr>
								<tr>
									<td>Åpen</td><td>{{=it.open || ''}}</td>
								</tr>
								<tr>
									<td>Avgift</td><td>{{=it.fee || ''}}</td>
								</tr>
								<tr>
									<td>Tidsbegrensning</td><td>{{=it.timeLimit || ''}}</td>
								</tr>
								<tr>
									<td>Contact Phone</td><td>{{=it.contactInfo || ''}}</td>
								</tr>					
							</tbody>
						</table>
					</div>
				</div>
	    	</div>
		</div>

		<div class="panel-group panel-group-sm">
		    <div class="panel panel-default panel-sm">
		      <div class="panel-heading panel-heading-sm">
		        <h5 class="panel-title">
		          <a data-toggle="collapse" href="#collapse3" onclick="updatePrefferedPanel(3)"><i class="fi-map"></i> Location</a>
		        </h5>
		      </div>
				<div id="collapse3" class="panel-collapse 
				{{? it.preferredPanel[2] == 3}}
				collapse in
				{{??}}
				collapse
				{{?}}
				"> 
					<div class="panel-body">
						Id: {{=it.uuid}}<br>	
						Adresse: {{=it.address}}<br>
						By: {{=it.city}}, {{=it.zipcode}} <br><br>
						Bruker kommentar: {{=it.userComment || ''}}
		
						{{? it.imageName == 'coming'}}
						<br><div><br> Image Coming Later.<br></div>
						{{??}}
						<br> <img class="img-rounded" src=http://www.nobil.no/img/ladestasjonbilder/{{=it.imageName}} />
						{{?}}

					</div>
				</div>
	    	</div>
		</div>

	</script>

</body>
</html>